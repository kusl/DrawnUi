# ==============================================================================
# FILE: .github/workflows/pr-validation.yml
# ==============================================================================
---
name: PR Validation

on:
  pull_request:
    branches: [ main, dev, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'src/Breakout.csproj'

jobs:
  validate-android:
    name: Validate Android Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '17'
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install MAUI workloads
      run: |
        dotnet nuget locals all --clear
        dotnet workload install maui
        dotnet workload install android
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: Build Android (Debug - Fast validation)
      run: |
        dotnet build ${{ env.PROJECT_PATH }} `
          -c Debug `
          -f net9.0-android `
          --no-restore `
          --verbosity normal

  # iOS validation temporarily disabled due to Xcode version requirement
  validate-ios:
    name: Validate iOS Build (Skipped - Xcode Version)
    runs-on: ubuntu-latest
    
    steps:
    - name: Skip iOS Validation
      run: |
        echo "⚠️ iOS validation skipped: .NET 9 requires Xcode 16.4, but GitHub macOS runners currently have 15.4"
        echo "This will be enabled once GitHub updates their macOS runners"
        echo "See: https://aka.ms/xcode-requirement"

  # MacCatalyst validation temporarily disabled for same reason  
  validate-maccatalyst:
    name: Validate MacCatalyst Build (Skipped - Xcode Version)
    runs-on: ubuntu-latest
    
    steps:
    - name: Skip MacCatalyst Validation
      run: |
        echo "⚠️ MacCatalyst validation skipped: .NET 9 requires Xcode 16.4, but GitHub macOS runners currently have 15.4"
        echo "This will be enabled once GitHub updates their macOS runners"
        echo "See: https://aka.ms/xcode-requirement"

  validate-windows:
    name: Validate Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install MAUI workloads
      run: |
        dotnet nuget locals all --clear
        dotnet workload install maui
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: Build Windows (Debug - Fast validation)
      run: |
        dotnet build ${{ env.PROJECT_PATH }} `
          -c Debug `
          -f net9.0-windows10.0.19041.0 `
          --no-restore `
          --verbosity normal

  code-analysis:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Run static analysis
      shell: pwsh
      run: |
        Write-Host "=== Code Quality Analysis ===" -ForegroundColor Cyan
        
        # Check for common issues
        Write-Host "`nChecking for TODO/FIXME comments..." -ForegroundColor Yellow
        try {
          $todos = Select-String -Path "src/**/*.cs" -Pattern "TODO|FIXME|HACK" -Recurse -ErrorAction SilentlyContinue
          if ($todos) { 
            Write-Host "Found items to review:" -ForegroundColor Yellow
            $todos | ForEach-Object { Write-Host "  $($_.Filename):$($_.LineNumber) - $($_.Line.Trim())" }
          } else { 
            Write-Host "✅ No TODO/FIXME/HACK comments found" -ForegroundColor Green 
          }
        } catch {
          Write-Host "⚠️  Could not check for TODO comments" -ForegroundColor Yellow
        }
        
        # Check project file integrity
        Write-Host "`nValidating solution structure..." -ForegroundColor Yellow
        dotnet sln list
        
        # Check for large files
        Write-Host "`nChecking for large files..." -ForegroundColor Yellow
        try {
          $largeFiles = Get-ChildItem -Path "src" -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.Length -gt 1MB }
          if ($largeFiles) {
            Write-Host "Large files found:" -ForegroundColor Yellow
            $largeFiles | ForEach-Object { Write-Host "  $($_.FullName) - $([math]::Round($_.Length/1MB, 2))MB" }
          } else {
            Write-Host "✅ No large files found" -ForegroundColor Green
          }
        } catch {
          Write-Host "⚠️  Could not check file sizes" -ForegroundColor Yellow
        }
        
        # Basic file count
        Write-Host "`nProject statistics:" -ForegroundColor Yellow
        $csFiles = Get-ChildItem -Path "src" -Filter "*.cs" -Recurse -ErrorAction SilentlyContinue
        Write-Host "  C# files: $($csFiles.Count)" -ForegroundColor White
        
        $xamlFiles = Get-ChildItem -Path "src" -Filter "*.xaml" -Recurse -ErrorAction SilentlyContinue
        Write-Host "  XAML files: $($xamlFiles.Count)" -ForegroundColor White

  generate-summary:
    name: Generate Summary
    needs: [validate-android, validate-ios, validate-maccatalyst, validate-windows, code-analysis]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Generate PR summary
      run: |
        echo "## 🎮 Breakout Game - PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job results
        if [ "${{ needs.validate-android.result }}" == "success" ]; then
          echo "- ✅ **Android Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Android Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # iOS and MacCatalyst are skipped, so always show as warning
        echo "- ⚠️ **iOS Build**: Skipped (Xcode version requirement)" >> $GITHUB_STEP_SUMMARY
        echo "- ⚠️ **MacCatalyst Build**: Skipped (Xcode version requirement)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.validate-windows.result }}" == "success" ]; then
          echo "- ✅ **Windows Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Windows Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.code-analysis.result }}" == "success" ]; then
          echo "- ✅ **Code Analysis**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Code Analysis**: Issues found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ⚠️ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "- **iOS/MacCatalyst builds are temporarily disabled**" >> $GITHUB_STEP_SUMMARY
        echo "- .NET 9 requires Xcode 16.4, but GitHub runners have 15.4" >> $GITHUB_STEP_SUMMARY
        echo "- These will be re-enabled when GitHub updates their runners" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🚀 Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Android and Windows platforms validated" >> $GITHUB_STEP_SUMMARY
        echo "- Ready for merge if all checks pass" >> $GITHUB_STEP_SUMMARY
